# راه‌اندازی ربات پشت پروکسی (هاست خارج از ایران)

برای اجرای ربات روی **سرور ایران** و دور زدن فیلتر تلگرام، یک فایل پروکسی روی **هاست خارج از ایران** قرار می‌گیرد و ترافیک وب‌هوک و API از طریق آن رد می‌شود.

## ۱) روی هاست خارجی (جایی که تلگرام فیلتر نیست)

- فایل **`proxy.php`** را آپلود کنید (مثلاً در روت دامنه یا یک زیرپوشه).
- آدرس وب‌هوک سرور ربات (ایران) را تنظیم کنید:
  - یا متغیر محیطی: `BOT_BACKEND_WEBHOOK_URL=http://IP_سرور_ایران:3000/webhook`
  - یا در خط ۲۲ همین فایل: مقدار `$BOT_BACKEND_WEBHOOK_URL` را با آدرس واقعی سرور ایران عوض کنید (مثلاً `http://123.45.67.89:3000/webhook`).
- اگر سرور ایران فقط از داخل ایران در دسترس است، باید از یک تونل (مثلاً در سرور ایران به سمت همان هاست خارجی) یا IP عمومی استفاده کنید تا هاست خارجی بتواند به `BOT_BACKEND_WEBHOOK_URL` برسد.

آدرس نهایی پروکسی مثلاً: `https://your-domain.com/proxy.php`

## ۲) روی سرور ایران (ربات Node)

در `.env` ربات این دو مقدار را تنظیم کنید:

```env
# آدرسی که تلگرام برای ارسال آپدیت‌ها استفاده می‌کند (همان آدرس پروکسی + /webhook)
WEBHOOK=https://your-domain.com/proxy.php

# آدرس پایهٔ API تا همهٔ درخواست‌های ربات به تلگرام از پروکسی رد شوند
TELEGRAM_API_ROOT=https://your-domain.com/proxy.php
```

- **WEBHOOK**: همان دامنهٔ پروکسی است؛ ربات با `setWebhook` به تلگرام می‌گوید آپدیت‌ها را به `WEBHOOK/webhook` بفرستد (یعنی به پروکسی).
- **TELEGRAM_API_ROOT**: باعث می‌شود Telegraf به جای `api.telegram.org` به این آدرس درخواست بزند (به صورت `/botTOKEN/method`).

بعد از تنظیم، ربات را ریستارت کنید تا وب‌هوک و مسیر API به‌روز شود.

## خلاصهٔ مسیر ترافیک

| جهت | مسیر |
|-----|------|
| تلگرام → ربات | تلگرام به `https://proxy.com/proxy.php/webhook` POST می‌زند → پروکسی همان بدنه را به `BOT_BACKEND_WEBHOOK_URL` (سرور ایران) فوروارد می‌کند. |
| ربات → تلگرام | ربات با `apiRoot` به `https://proxy.com/proxy.php/botTOKEN/method` درخواست می‌زند → پروکسی به `api.telegram.org` فوروارد می‌کند و پاسخ را برمی‌گرداند. |
